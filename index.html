<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PREVISI√ìN BICI</title>
    <style>
        :root { 
            --low: #e0f2fe;    
            --med: #7dd3fc;    
            --high: #0369a1;   
            --cold: #38bdf8;   
            --hot: #fb923c;    
            --danger: #ef4444; 
            --neon: #0f0;      
        }
        
        * { box-sizing: border-box; font-family: 'Arial Black', sans-serif; } 

        body { background: #1a1a1a; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        .phone-container { 
            width: 100%; max-width: 450px; 
            background: #000; 
            display: block; 
            padding: 8px;
            height: fit-content;
        }

        .header-title { 
            background: #333; color: white; text-align: center; 
            padding: 10px; border-radius: 10px; font-size: 1.2rem;
            text-transform: uppercase; margin-bottom: 8px;
        }

        .content-section { display: none; margin-bottom: 8px; width: 100%; }
        .active-section { display: flex; flex-direction: column; gap: 8px; }

        /* Ajuste del contenedor del mapa para que sea visible */
        #section-mapa { 
            height: 500px; 
            width: 100%;
            border-radius: 20px; 
            overflow: hidden; 
            background: #222;
            border: 2px solid #333;
        }
        iframe { width: 100%; height: 100%; border: none; }

        .hour-card { 
            border-radius: 20px; padding: 5px;
            display: grid; grid-template-columns: 100px 1fr 1fr 95px; 
            gap: 5px; 
            border: 5px solid transparent;
            min-height: 105px;
        }
        
        .risk-low { background: var(--low); border-color: var(--low); }
        .risk-med { background: var(--med); border-color: var(--med); }
        .risk-high { background: var(--high); border-color: var(--high); }

        .sub-box { 
            border-radius: 12px; 
            display: flex; flex-direction: column; 
            align-items: center; 
            justify-content: space-between; 
            color: white; text-align: center;
            line-height: 0.9;
            padding: 6px 2px 2px 2px; 
            background: #000;
        }

        .c-low { color: var(--low) !important; }
        .c-med { color: var(--med) !important; }
        .c-high { color: var(--danger) !important; }
        .c-cold { color: var(--cold) !important; }
        .c-hot { color: var(--hot) !important; }

        .label { font-size: 0.65rem; text-transform: uppercase; margin-bottom: 2px; opacity: 0.5; font-weight: bold; color: #fff; }
        
        .val-big { 
            font-size: 2.6rem; font-weight: 900; letter-spacing: -2px; 
            margin-top: 0px; line-height: 0.9;   
        } 

        .val-small { 
            font-size: 1.1rem; font-weight: bold; margin-top: -4px;   
            margin-bottom: 0; opacity: 0.8; line-height: 1; 
        }

        .unit-tiny { 
            font-size: 0.7rem; vertical-align: baseline; margin-left: 2px; 
            opacity: 0.7; font-weight: normal; text-transform: lowercase;
        }

        .time-box { background: #000 !important; justify-content: center; padding-top: 0; position: relative; }
        .time-display, .time-input { 
            font-size: 1.5rem; font-weight: 900; color: white; 
            height: 40px; line-height: 40px; text-align: center;
        }
        .time-input { 
            background: transparent; border: none; color: var(--neon); 
            width: 100%; outline: none; cursor: pointer; -webkit-appearance: none;
        }
        .time-input::-webkit-calendar-picker-indicator { 
            position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }

        .weather-icon { font-size: 3.8rem; line-height: 1; margin-top: 2px; }

        .nav-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 0; }
        .nav-btn { background: #222; color: #666; border: none; padding: 18px; border-radius: 15px; font-size: 1.4rem; font-weight: 900; cursor: pointer;}
        .nav-btn.active { background: #333; color: #fff; outline: 3px solid #444; }
    </style>
</head>
<body onload="init()">

<div class="phone-container">
    <div class="header-title">PREVISI√ìN BICI</div>
    
    <div id="section-list" class="content-section active-section"></div>
    
    <div id="section-mapa" class="content-section">
        <iframe id="map-frame" src=""></iframe>
    </div>

    <nav class="nav-bar">
        <button id="btn-datos" class="nav-btn active" onclick="showSection('datos')">DATOS</button>
        <button id="btn-mapa" class="nav-btn" onclick="showSection('mapa')">MAPAS</button>
    </nav>
</div>

<script>
const LAT = 40.342, LON = -3.831;
let weatherData = null;
const weatherIcons = { 0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 45: "üå´Ô∏è", 51: "üå¶Ô∏è", 61: "üåßÔ∏è", 80: "üå¶Ô∏è", 95: "‚õàÔ∏è" };

async function init() {
    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,apparent_temperature,precipitation,precipitation_probability,wind_speed_10m,wind_gusts_10m,weather_code&timezone=auto&forecast_days=2`);
    weatherData = await response.json();
    const currentHour = new Date().getHours().toString().padStart(2, '0') + ":00";
    renderForecast(currentHour);
}

function getColor(type, val, extra = 0) {
    if (type === 'temp') {
        if (val < 12) return 'c-cold';
        if (val > 32) return 'c-high';
        if (val > 25) return 'c-hot';
        return '';
    }
    if (type === 'wind') {
        if (val > 30) return 'c-high';
        if (val > 15) return 'c-med';
        return '';
    }
    if (type === 'rain') {
        if (val > 40 || extra > 0.5) return 'c-high';
        if (val > 15 || extra > 0.1) return 'c-med';
        return 'c-low';
    }
    return '';
}

function renderForecast(startTime) {
    const list = document.getElementById('section-list');
    let html = '';
    const h = weatherData.hourly;
    let targetHour = startTime || new Date().getHours().toString().padStart(2, '0') + ":00";
    let startIdx = h.time.findIndex(t => t.includes(`T${targetHour.split(':')[0]}:00`));
    if (startIdx === -1) startIdx = 0;

    for (let i = 0; i < 5; i++) {
        const idx = startIdx + i;
        if (!h.time[idx]) break;

        const time = h.time[idx].split('T')[1], 
              temp = Math.round(h.temperature_2m[idx]), 
              feel = Math.round(h.apparent_temperature[idx]), 
              prob = h.precipitation_probability[idx],
              rain = h.precipitation[idx], 
              wind = Math.round(h.wind_speed_10m[idx]), 
              gusts = Math.round(h.wind_gusts_10m[idx]);

        let riskClass = (prob > 40 || rain > 0.5) ? 'risk-high' : (prob > 15 || rain > 0.1) ? 'risk-med' : 'risk-low';

        html += `
            <div class="hour-card ${riskClass}">
                <div class="sub-box time-box">
                    ${i === 0 
                        ? `<input type="time" class="time-input" value="${time}" onchange="renderForecast(this.value)">` 
                        : `<div class="time-display">${time}</div>`
                    }
                    <div class="weather-icon">${weatherIcons[h.weather_code[idx]] || "üå§Ô∏è"}</div>
                </div>
                <div class="sub-box">
                    <span class="label">TEMP</span>
                    <span class="val-big ${getColor('temp', temp)}">${temp}¬∞</span>
                    <span class="val-small">${feel}¬∞</span>
                </div>
                <div class="sub-box">
                    <span class="label">LLUVIA</span>
                    <span class="val-big ${getColor('rain', prob, rain)}">${prob > 0 ? prob+'%' : ''}</span>
                    <span class="val-small">${rain > 0 ? rain.toFixed(1) + '<span class="unit-tiny">mm</span>' : ''}</span>
                </div>
                <div class="sub-box">
                    <span class="label">VIENTO</span>
                    <span class="val-big ${getColor('wind', wind)}">${wind > 0 ? wind + '<span class="unit-tiny">km</span>' : ''}</span>
                    <span class="val-small">${gusts > 0 ? '('+gusts+')' : ''}</span>
                </div>
            </div>`;
    }
    list.innerHTML = html;
}

function showSection(s) {
    const list = document.getElementById('section-list');
    const mapa = document.getElementById('section-mapa');
    const iframe = document.getElementById('map-frame');

    if (s === 'datos') {
        list.style.display = 'flex';
        mapa.style.display = 'none';
        document.getElementById('btn-datos').classList.add('active');
        document.getElementById('btn-mapa').classList.remove('active');
    } else {
        list.style.display = 'none';
        mapa.style.display = 'block';
        document.getElementById('btn-datos').classList.remove('active');
        document.getElementById('btn-mapa').classList.add('active');
        
        // URL de Windy corregida para que cargue correctamente
        if (iframe.src === "" || iframe.src === window.location.href) {
            iframe.src = `https://embed.windy.com/embed2.html?lat=${LAT}&lon=${LON}&zoom=8&level=surface&overlay=rain&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;
        }
    }
}
</script>
</body>
</html>